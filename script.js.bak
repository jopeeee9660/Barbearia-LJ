// Verificar autenticação e inicializar funcionalidades
if (!window.auth) {
    window.auth = {
        checkAuth: function() {
            return localStorage.getItem('logado') === 'true';
        }
    };
}
if (!auth || !auth.checkAuth()) {
    window.location.href = "login/login.html";
}

// Configuração do carrossel de imagens
let imagens = [
    "imagens/imagem1.jpg",
    "imagens/imagem2.jpg",
    "imagens/imagem3.jpg",
    "imagens/imagem4.jpg"
];

let indiceAtual = 0;
let intervaloCarrossel;

function trocarImagem(direcao) {
    clearInterval(intervaloCarrossel);
    indiceAtual += direcao;
    if (indiceAtual < 0) {
        indiceAtual = imagens.length - 1;
    } else if (indiceAtual >= imagens.length) {
        indiceAtual = 0;
    }
    document.getElementById("imagem-principal").src = imagens[indiceAtual];
    iniciarCarrosselAutomatico();
}

function iniciarCarrosselAutomatico() {
    intervaloCarrossel = setInterval(() => {
        trocarImagem(1);
    }, 5000);
}

// Iniciar carrossel quando a página carregar
document.addEventListener('DOMContentLoaded', iniciarCarrosselAutomatico);

// Controle da sidebar
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const btn = document.querySelector('.btn-menu');
    sidebar.classList.toggle('active');
    btn.textContent = sidebar.classList.contains('active') ? "✖" : "☰";
}

// Scroll suave para seções
function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth' });
        toggleSidebar(); // Fecha o menu após clicar
    }
}

// Sistema de agendamento
// Funções do Modal de Agendamento
function abrirModal(servico) {
    const modal = document.getElementById('modal-agendamento');
    const servicoInput = document.getElementById('servico-selecionado');
    const dataHoraInput = document.getElementById('data-hora');
    
    // Define o serviço selecionado
    servicoInput.value = servico;
    
    // Configura a data mínima como hoje
    const agora = new Date();
    const dataMinima = agora.toISOString().slice(0, 16);
    dataHoraInput.min = dataMinima;
    
    // Abre o modal
    modal.style.display = 'block';
    
    // Impede o scroll da página
    document.body.style.overflow = 'hidden';
}

function fecharModal() {
    const modal = document.getElementById('modal-agendamento');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Limpa os campos
    document.getElementById('form-agendamento').reset();
    document.getElementById('pix-info').style.display = 'none';
    document.getElementById('cartao-info').style.display = 'none';
}

function inicializarModalAgendamento() {
    // Configura o método de pagamento
    const metodoPagamento = document.getElementById('metodo-pagamento');
    if (metodoPagamento) {
        metodoPagamento.addEventListener('change', function() {
            const pixInfo = document.getElementById('pix-info');
            const cartaoInfo = document.getElementById('cartao-info');
            
            if (this.value === 'pix') {
                pixInfo.style.display = 'block';
                cartaoInfo.style.display = 'none';
            } else if (this.value === 'cartao') {
                pixInfo.style.display = 'none';
                cartaoInfo.style.display = 'block';
            } else {
                pixInfo.style.display = 'none';
                cartaoInfo.style.display = 'none';
            }
        });
    }

// Formatação do cartão
document.getElementById('validade').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 2) {
        value = value.slice(0,2) + '/' + value.slice(2,4);
    }
    e.target.value = value;
});

document.getElementById('numero-cartao').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{4})/g, '$1 ').trim();
    e.target.value = value;
});

function agendarServico(servico) {
    abrirModal(servico);
}

function inicializarFormularioAgendamento() {
    const formAgendamento = document.getElementById('form-agendamento');
    if (formAgendamento) {
        formAgendamento.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const servico = document.getElementById('servico-selecionado').value;
            const dataHora = document.getElementById('data-hora').value;
            const metodoPagamento = document.getElementById('metodo-pagamento').value;
            
            if (!dataHora) {
                alert('Por favor, selecione uma data e hora para o agendamento.');
                return;
            }

            const dataAgendamento = new Date(dataHora);
            const agora = new Date();

            if (dataAgendamento < agora) {
                alert('Por favor, selecione uma data futura para o agendamento.');
                return;
            }

            let dadosPagamento = {};
            
            if (metodoPagamento === 'cartao') {
                dadosPagamento = {
                    numero: document.getElementById('numero-cartao').value,
                    validade: document.getElementById('validade').value,
                    cvv: document.getElementById('cvv').value,
                    nome: document.getElementById('nome-cartao').value
                };
                
                if (!dadosPagamento.numero || !dadosPagamento.validade || !dadosPagamento.cvv || !dadosPagamento.nome) {
                    alert('Por favor, preencha todos os dados do cartão.');
                    return;
                }
            }

            const agendamento = {
                servico,
                dataHora,
                metodoPagamento,
                dadosPagamento,
                cliente: localStorage.getItem('usuario'),
                status: 'confirmado'
            };

            const agendamentos = JSON.parse(localStorage.getItem('agendamentos') || '[]');
            agendamentos.push(agendamento);
            localStorage.setItem('agendamentos', JSON.stringify(agendamentos));

            alert('Agendamento realizado com sucesso!');
            fecharModal();
        });
    }

    // Inicializar máscaras de cartão
    const numeroCartao = document.getElementById('numero-cartao');
    const validade = document.getElementById('validade');

    if (numeroCartao) {
        numeroCartao.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})/g, '$1 ').trim();
            e.target.value = value;
        });
    }

    if (validade) {
        validade.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.slice(0,2) + '/' + value.slice(2,4);
            }
            e.target.value = value;
        });
    }
}

// Sistema de tradução
const traducoes = {
    pt: {
        inicio: "Início",
        "inicio-texto": "Aqui você encontra os melhores profissionais para cuidar do seu visual!",
        sobre: "Sobre",
        "sobre-texto": "Com anos de experiência no mercado, a Barbearia LJ se destaca pela qualidade e profissionalismo.",
        contato: "Contato",
        pesquisa: "Pesquise serviços",
        onde: "Onde?",
        quando: "Quando?",
        "modal-titulo": "Agendar Serviço",
        "label-servico": "Serviço:",
        "label-data": "Data e Hora:",
        "label-pagamento": "Método de Pagamento:",
        "select-pagamento": "Selecione o método de pagamento",
        "opcao-pix": "PIX",
        "opcao-cartao": "Cartão de Crédito/Débito",
        "pix-instrucoes": "Após confirmar, você receberá o QR Code do PIX",
        "btn-confirmar": "Confirmar Agendamento",
        "numero-cartao": "Número do Cartão",
        "validade": "MM/AA",
        "cvv": "CVV",
        "nome-cartao": "Nome no Cartão"
    },
    en: {
        inicio: "Home",
        "inicio-texto": "Here you'll find the best professionals to take care of your style!",
        sobre: "About",
        "sobre-texto": "With years of experience in the market, Barbearia LJ stands out for its quality and professionalism.",
        contato: "Contact",
        pesquisa: "Search services",
        onde: "Where?",
        quando: "When?",
        "modal-titulo": "Schedule Service",
        "label-servico": "Service:",
        "label-data": "Date and Time:",
        "label-pagamento": "Payment Method:",
        "select-pagamento": "Select payment method",
        "opcao-pix": "PIX",
        "opcao-cartao": "Credit/Debit Card",
        "pix-instrucoes": "After confirming, you will receive the PIX QR Code",
        "btn-confirmar": "Confirm Scheduling",
        "numero-cartao": "Card Number",
        "validade": "MM/YY",
        "cvv": "CVV",
        "nome-cartao": "Name on Card"
    },
    es: {
        inicio: "Inicio",
        "inicio-texto": "¡Aquí encontrarás los mejores profesionales para cuidar tu imagen!",
        sobre: "Sobre Nosotros",
        "sobre-texto": "Con años de experiencia en el mercado, Barbearia LJ se destaca por su calidad y profesionalismo.",
        contato: "Contacto",
        pesquisa: "Buscar servicios",
        onde: "¿Dónde?",
        quando: "¿Cuándo?",
        "modal-titulo": "Programar Servicio",
        "label-servico": "Servicio:",
        "label-data": "Fecha y Hora:",
        "label-pagamento": "Método de Pago:",
        "select-pagamento": "Seleccione el método de pago",
        "opcao-pix": "PIX",
        "opcao-cartao": "Tarjeta de Crédito/Débito",
        "pix-instrucoes": "Después de confirmar, recibirá el código QR de PIX",
        "btn-confirmar": "Confirmar Programación",
        "numero-cartao": "Número de Tarjeta",
        "validade": "MM/AA",
        "cvv": "CVV",
        "nome-cartao": "Nombre en la Tarjeta"
    }
};

function trocarIdioma(idioma) {
    const texto = traducoes[idioma];
    for (let chave in texto) {
        const elemento = document.getElementById(chave);
        if (elemento) {
            if (elemento.tagName === "INPUT") {
                elemento.placeholder = texto[chave];
            } else {
                elemento.textContent = texto[chave];
            }
        }
    }
}

// Atualizar a data mínima do input datetime-local para hoje
// Inicialização quando a página carregar
document.addEventListener('DOMContentLoaded', () => {
    // Configurar data mínima
    const hoje = new Date();
    const dataMinima = hoje.toISOString().split('T')[0];
    const quandoInput = document.getElementById('quando');
    if (quandoInput) {
        quandoInput.min = dataMinima;
    }
    
    // Event listeners do modal
    const closeModal = document.querySelector('.close-modal');
    const modal = document.getElementById('modal-agendamento');
    
    if (closeModal && modal) {
        closeModal.addEventListener('click', fecharModal);
        
        // Fechar modal quando clicar fora
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                fecharModal();
            }
        });
        
        // Fechar modal com tecla ESC
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'block') {
                fecharModal();
            }
        });
    }

    // Inicializar componentes do modal
    inicializarModalAgendamento();
    inicializarFormularioAgendamento();
});